;; gorilla-repl.fileformat = 1

;; **
;;; # MNIST train monitor
;; **

;; @@
(ns view-mnist-train
  (:require [gorilla-plot.core :as plot]
            [mnist.plot :as mplot]
            [neuro.train :as nt]))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=

;; **
;;; ## Loss History of last 100th
;; **

;; @@
(mplot/plot-train)
;; @@
;; ->
;;; epoch 1, last loss 0.132291
;;; 
;; <-
;; =>
;;; {"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"e4b229e6-dece-4327-a97b-42824cf97afb","values":[{"x":0,"y":0.050484783813899446},{"x":1,"y":4.911166065550739E-6},{"x":2,"y":8.828622652731535E-6},{"x":3,"y":0.06530675273442933},{"x":4,"y":0.626117531978495},{"x":5,"y":0.1907293985737226},{"x":6,"y":0.13077200403244543},{"x":7,"y":2.3267231283302083E-5},{"x":8,"y":0.18842039785680514},{"x":9,"y":8.38198230051413E-6},{"x":10,"y":0.04047368833835784},{"x":11,"y":0.03873952704314486},{"x":12,"y":0.3430819148195501},{"x":13,"y":0.07371241981936563},{"x":14,"y":1.0596230374201723E-5},{"x":15,"y":1.9520523522911907E-5},{"x":16,"y":1.1364717874413057E-5},{"x":17,"y":0.09563354444009563},{"x":18,"y":0.02499849002888413},{"x":19,"y":0.09444327901511701},{"x":20,"y":0.271149236302919},{"x":21,"y":4.1579021884312265E-6},{"x":22,"y":0.3456396111032616},{"x":23,"y":0.1192583847695214},{"x":24,"y":0.13261312174810297},{"x":25,"y":0.28046587156109964},{"x":26,"y":0.1630474841621027},{"x":27,"y":3.5575752142355896E-6},{"x":28,"y":0.008796495547057779},{"x":29,"y":0.002440142621107989},{"x":30,"y":0.16847858564414575},{"x":31,"y":0.19573064165266102},{"x":32,"y":7.714770926232236E-6},{"x":33,"y":3.0317154092966174E-6},{"x":34,"y":5.7320173388096385E-6},{"x":35,"y":0.09552419717880206},{"x":36,"y":0.09863745263297882},{"x":37,"y":0.6276842513894436},{"x":38,"y":0.2091520759587831},{"x":39,"y":0.2654251563061317},{"x":40,"y":0.14321230854971},{"x":41,"y":0.39724385592946565},{"x":42,"y":0.1989131051965442},{"x":43,"y":0.0767302771112047},{"x":44,"y":0.02202328624944108},{"x":45,"y":0.3613189420860746},{"x":46,"y":0.07074337893402667},{"x":47,"y":7.290309097432232E-4},{"x":48,"y":1.1419504561621183E-5},{"x":49,"y":0.07068917102520471},{"x":50,"y":1.0869921121822301E-5},{"x":51,"y":3.807259588543307E-5},{"x":52,"y":2.444324032735955E-6},{"x":53,"y":0.00477254799367442},{"x":54,"y":0.4305550801577521},{"x":55,"y":0.22450701205241758},{"x":56,"y":0.09506733424845086},{"x":57,"y":0.3109245309502208},{"x":58,"y":0.03995095114858253},{"x":59,"y":0.057022441713830876},{"x":60,"y":0.2263175984736125},{"x":61,"y":0.08472038810576249},{"x":62,"y":0.26479058980669523},{"x":63,"y":0.10133432395366156},{"x":64,"y":0.11751165541113724},{"x":65,"y":3.7546007861266315E-6},{"x":66,"y":0.021847724097718024},{"x":67,"y":0.20233560641791465},{"x":68,"y":0.21667128904422336},{"x":69,"y":3.938760100391188E-6},{"x":70,"y":2.9950260921820514E-6},{"x":71,"y":6.4143902773424784E-6},{"x":72,"y":0.052686300262454654},{"x":73,"y":0.036637410685059005},{"x":74,"y":0.04246710347572859},{"x":75,"y":3.656710440890755E-6},{"x":76,"y":0.006407881192812893},{"x":77,"y":0.12975311785119695},{"x":78,"y":2.7192577731119477E-6},{"x":79,"y":4.834893408650375E-6},{"x":80,"y":1.6455110169880463E-6},{"x":81,"y":0.07302290116554695},{"x":82,"y":1.6644533005422528E-6},{"x":83,"y":6.4999567837184585E-6},{"x":84,"y":1.4020066388934794E-6},{"x":85,"y":0.03944702151029697},{"x":86,"y":0.19370212715048724},{"x":87,"y":0.24230589161076144},{"x":88,"y":0.15836366126140197},{"x":89,"y":4.45416450444386E-6},{"x":90,"y":4.4247396078346734E-7},{"x":91,"y":0.14193105447330373},{"x":92,"y":0.14378939930721474},{"x":93,"y":0.18162560418482515},{"x":94,"y":6.6944047670937935E-6},{"x":95,"y":0.09916240623497474},{"x":96,"y":0.4033205684353508},{"x":97,"y":0.19057943775434621},{"x":98,"y":0.10725912671488289},{"x":99,"y":0.1322906302865942}]}],"marks":[{"type":"line","from":{"data":"e4b229e6-dece-4327-a97b-42824cf97afb"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"stroke":{"value":"#FF29D2"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"e4b229e6-dece-4327-a97b-42824cf97afb","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"e4b229e6-dece-4327-a97b-42824cf97afb","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"e4b229e6-dece-4327-a97b-42824cf97afb\", :values ({:x 0, :y 0.050484783813899446} {:x 1, :y 4.911166065550739E-6} {:x 2, :y 8.828622652731535E-6} {:x 3, :y 0.06530675273442933} {:x 4, :y 0.626117531978495} {:x 5, :y 0.1907293985737226} {:x 6, :y 0.13077200403244543} {:x 7, :y 2.3267231283302083E-5} {:x 8, :y 0.18842039785680514} {:x 9, :y 8.38198230051413E-6} {:x 10, :y 0.04047368833835784} {:x 11, :y 0.03873952704314486} {:x 12, :y 0.3430819148195501} {:x 13, :y 0.07371241981936563} {:x 14, :y 1.0596230374201723E-5} {:x 15, :y 1.9520523522911907E-5} {:x 16, :y 1.1364717874413057E-5} {:x 17, :y 0.09563354444009563} {:x 18, :y 0.02499849002888413} {:x 19, :y 0.09444327901511701} {:x 20, :y 0.271149236302919} {:x 21, :y 4.1579021884312265E-6} {:x 22, :y 0.3456396111032616} {:x 23, :y 0.1192583847695214} {:x 24, :y 0.13261312174810297} {:x 25, :y 0.28046587156109964} {:x 26, :y 0.1630474841621027} {:x 27, :y 3.5575752142355896E-6} {:x 28, :y 0.008796495547057779} {:x 29, :y 0.002440142621107989} {:x 30, :y 0.16847858564414575} {:x 31, :y 0.19573064165266102} {:x 32, :y 7.714770926232236E-6} {:x 33, :y 3.0317154092966174E-6} {:x 34, :y 5.7320173388096385E-6} {:x 35, :y 0.09552419717880206} {:x 36, :y 0.09863745263297882} {:x 37, :y 0.6276842513894436} {:x 38, :y 0.2091520759587831} {:x 39, :y 0.2654251563061317} {:x 40, :y 0.14321230854971} {:x 41, :y 0.39724385592946565} {:x 42, :y 0.1989131051965442} {:x 43, :y 0.0767302771112047} {:x 44, :y 0.02202328624944108} {:x 45, :y 0.3613189420860746} {:x 46, :y 0.07074337893402667} {:x 47, :y 7.290309097432232E-4} {:x 48, :y 1.1419504561621183E-5} {:x 49, :y 0.07068917102520471} {:x 50, :y 1.0869921121822301E-5} {:x 51, :y 3.807259588543307E-5} {:x 52, :y 2.444324032735955E-6} {:x 53, :y 0.00477254799367442} {:x 54, :y 0.4305550801577521} {:x 55, :y 0.22450701205241758} {:x 56, :y 0.09506733424845086} {:x 57, :y 0.3109245309502208} {:x 58, :y 0.03995095114858253} {:x 59, :y 0.057022441713830876} {:x 60, :y 0.2263175984736125} {:x 61, :y 0.08472038810576249} {:x 62, :y 0.26479058980669523} {:x 63, :y 0.10133432395366156} {:x 64, :y 0.11751165541113724} {:x 65, :y 3.7546007861266315E-6} {:x 66, :y 0.021847724097718024} {:x 67, :y 0.20233560641791465} {:x 68, :y 0.21667128904422336} {:x 69, :y 3.938760100391188E-6} {:x 70, :y 2.9950260921820514E-6} {:x 71, :y 6.4143902773424784E-6} {:x 72, :y 0.052686300262454654} {:x 73, :y 0.036637410685059005} {:x 74, :y 0.04246710347572859} {:x 75, :y 3.656710440890755E-6} {:x 76, :y 0.006407881192812893} {:x 77, :y 0.12975311785119695} {:x 78, :y 2.7192577731119477E-6} {:x 79, :y 4.834893408650375E-6} {:x 80, :y 1.6455110169880463E-6} {:x 81, :y 0.07302290116554695} {:x 82, :y 1.6644533005422528E-6} {:x 83, :y 6.4999567837184585E-6} {:x 84, :y 1.4020066388934794E-6} {:x 85, :y 0.03944702151029697} {:x 86, :y 0.19370212715048724} {:x 87, :y 0.24230589161076144} {:x 88, :y 0.15836366126140197} {:x 89, :y 4.45416450444386E-6} {:x 90, :y 4.4247396078346734E-7} {:x 91, :y 0.14193105447330373} {:x 92, :y 0.14378939930721474} {:x 93, :y 0.18162560418482515} {:x 94, :y 6.6944047670937935E-6} {:x 95, :y 0.09916240623497474} {:x 96, :y 0.4033205684353508} {:x 97, :y 0.19057943775434621} {:x 98, :y 0.10725912671488289} {:x 99, :y 0.1322906302865942})}], :marks [{:type \"line\", :from {:data \"e4b229e6-dece-4327-a97b-42824cf97afb\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :stroke {:value \"#FF29D2\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"e4b229e6-dece-4327-a97b-42824cf97afb\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"e4b229e6-dece-4327-a97b-42824cf97afb\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; **
;;; ## Classify random sampling test image by current neural network
;; **

;; @@
(mplot/rand-check-view)
;; @@
;; ->
;;; Succeed! 0
;;; 
;; <-
;; =>
;;; {"type":"html","content":"<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJYAAACWCAYAAAA8AXHiAAAC10lEQVR42u3dzWrCQBSA0fjz/o8ZFAVFUVAxLVnPHcg0xDrJGfh2xYb2uBgn3jRN0/xIE+SPILAElsCSwBJYAksCS2AJLAksgSWwJLAElsCSwBJYAksCS2AJLAksgSWwJLAEVr2tVquktm3DTqdT0na7TQJLYIEFFlhggQUWWGCNLMLSdV1SyXq9XkkR1j6wwAILLLDAAgsssMACCyywPvFxweVyCfvUWq/XYWCBBRZYYIEFFlhggbUYWBGiaFdWsp7PZ9LYdTwew8ACCyywwAILLLDAAmvRsErW4/FIil4zt6sbutN8v99h+/0+CSywwAILLLDAAgsssMACC6yhRVv4sbDGXtNut0sqWbfbLexLbxQECyywwAILLLDAAgusYd3v96Sxa7PZJI29ztyucux5I1hggQUWWGCBBRZYYFWx+8vtAKNhaDUdSUU3GvZdr9cksMACCyywwAILLLDAAgusZcDKnZ9Fq/Zx2CVzJr5gHgRYYIEFFlhggQUWWEuGVfLNm+issPY3UQmsKc41wQILLLDAAgsssMACa5Jv3szxoZMlsBzpgAUWWGCBBRZYYIEFFljzg1Wy5vhwyRwsN/qBBRZYYIEFFlhggVXNueAcYZXMc/jSCctggQUWWGCBBRZYYC0F1thhZLXAiq4z9yaKHuTZ96X/Q7DAAgsssMACCyywwAILLGeFfx6mNnQewz/MZAALLLDAAgsssMACC6x5wYp+fzS1ObfT8xR7sMACCyywwAILLLDAAgusGmDlzvqGfoRwOBzCav+qGlhggQUWWGCBBRZYC4cV7apy63w+J5Vgi87kop1able3lGFwYIEFFlhggQUWWGCBNck8h67rknI32kU/O/Q1+yq6IQ8ssMACCyywwAILLLDAAqvicmd1Jc/dGbratk1aGBawwAILLLDAAgsssMASWBJYAktgSWAJLIElgSWwBJYElsASWBJYAkvV9wudz+BtrG1X+AAAAABJRU5ErkJggg==\" width=\"150\" height=\"150\" alt=\"\" />","value":"#object[java.awt.image.BufferedImage 0x3a7f8686 \"BufferedImage@3a7f8686: type = 10 ColorModel: #pixelBits = 8 numComponents = 1 color space = java.awt.color.ICC_ColorSpace@68ca9126 transparency = 1 has alpha = false isAlphaPre = false ByteInterleavedRaster: width = 28 height = 28 #numDataElements 1 dataOff[0] = 0\"]"}
;; <=

;; **
;;; ## All Loss History
;; **

;; @@
(plot/list-plot @nt/*train-loss-history* :joined true :plot-size 800)
;; @@
;; =>
;;; {"type":"vega","content":{"width":800,"height":494.4375915527344,"padding":{"top":10,"left":55,"bottom":40,"right":10},"data":[{"name":"e1bdbdff-af23-4c8b-8c04-ce854066b5b8","values":[{"x":0,"y":null},{"x":1,"y":3.535602378666339},{"x":2,"y":4.485095685684816},{"x":3,"y":3.1382855621219963},{"x":4,"y":2.945144114461109},{"x":5,"y":1.0971406769616543},{"x":6,"y":1.3499534411938512},{"x":7,"y":2.5458104950903766},{"x":8,"y":0.8148775054099602},{"x":9,"y":1.279725410869905},{"x":10,"y":1.5642008694142908},{"x":11,"y":2.031831240236232},{"x":12,"y":1.1879635039468477},{"x":13,"y":3.3678758340058854},{"x":14,"y":0.6740764314409697},{"x":15,"y":0.7155740367780992},{"x":16,"y":0.3570483285551763},{"x":17,"y":0.5926457458638893},{"x":18,"y":0.9336968748347904},{"x":19,"y":2.0574670941080817},{"x":20,"y":0.5063754261376852},{"x":21,"y":0.47155528080092307},{"x":22,"y":0.40666204881169643},{"x":23,"y":1.511672038260718},{"x":24,"y":0.35077572016671776},{"x":25,"y":0.30094398206199113},{"x":26,"y":0.3838040597045923},{"x":27,"y":0.6567282062408066},{"x":28,"y":0.04369453312518749}]}],"marks":[{"type":"line","from":{"data":"e1bdbdff-af23-4c8b-8c04-ce854066b5b8"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"stroke":{"value":"#FF29D2"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}],"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"e1bdbdff-af23-4c8b-8c04-ce854066b5b8","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"e1bdbdff-af23-4c8b-8c04-ce854066b5b8","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 800, :height 494.4376, :padding {:top 10, :left 55, :bottom 40, :right 10}, :data [{:name \"e1bdbdff-af23-4c8b-8c04-ce854066b5b8\", :values ({:x 0, :y nil} {:x 1, :y 3.535602378666339} {:x 2, :y 4.485095685684816} {:x 3, :y 3.1382855621219963} {:x 4, :y 2.945144114461109} {:x 5, :y 1.0971406769616543} {:x 6, :y 1.3499534411938512} {:x 7, :y 2.5458104950903766} {:x 8, :y 0.8148775054099602} {:x 9, :y 1.279725410869905} {:x 10, :y 1.5642008694142908} {:x 11, :y 2.031831240236232} {:x 12, :y 1.1879635039468477} {:x 13, :y 3.3678758340058854} {:x 14, :y 0.6740764314409697} {:x 15, :y 0.7155740367780992} {:x 16, :y 0.3570483285551763} {:x 17, :y 0.5926457458638893} {:x 18, :y 0.9336968748347904} {:x 19, :y 2.0574670941080817} {:x 20, :y 0.5063754261376852} {:x 21, :y 0.47155528080092307} {:x 22, :y 0.40666204881169643} {:x 23, :y 1.511672038260718} {:x 24, :y 0.35077572016671776} {:x 25, :y 0.30094398206199113} {:x 26, :y 0.3838040597045923} {:x 27, :y 0.6567282062408066} {:x 28, :y 0.04369453312518749})}], :marks [{:type \"line\", :from {:data \"e1bdbdff-af23-4c8b-8c04-ce854066b5b8\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :stroke {:value \"#FF29D2\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}}], :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"e1bdbdff-af23-4c8b-8c04-ce854066b5b8\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"e1bdbdff-af23-4c8b-8c04-ce854066b5b8\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}]}}"}
;; <=

;; @@
(mod (count @nt/*train-loss-history*) @nt/*num-batchs*)
@nt/*num-batchs*
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-unkown'>2500</span>","value":"2500"}
;; <=

;; @@
(mnist.core/print-time-to-next-epoch)
;; @@
;; ->
;;; start next epoch at 93.53 min later
;;; 
;; <-
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=

;; @@

;; @@
